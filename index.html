<!DOCTYPE html>
<html lang="ru" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Accounting - Бухгалтерия в браузере</title>
    
    <!-- Bootstrap 5 Compact -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #333;
            background-color: #f5f7fa;
            height: 100%;
        }
        
        .mono-font {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8125rem;
        }
        
        .compact-form .form-control {
            padding: 0.25rem 0.5rem;
            font-size: 0.8125rem;
            height: calc(1.5em + 0.5rem + 2px);
        }
        
        .compact-form .form-select {
            padding: 0.25rem 2.25rem 0.25rem 0.5rem;
            font-size: 0.8125rem;
            height: calc(1.5em + 0.5rem + 2px);
        }
        
        .compact-form .btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8125rem;
        }
        
        .card-sm {
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
        }
        
        .card-header-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .card-body-sm {
            padding: 0.75rem;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #1a2530 100%);
            color: white;
            width: 220px;
            transition: all 0.3s;
        }
        
        .sidebar-collapsed {
            width: 60px;
        }
        
        .nav-link-sidebar {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.5rem 1rem;
            margin: 0.125rem 0;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        
        .nav-link-sidebar:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-link-sidebar.active {
            background: var(--secondary-color);
            color: white;
        }
        
        .main-content {
            /* margin-left: 220px; */
            transition: all 0.3s;
        }
        
        .main-content-expanded {
            /* margin-left: 60px; */
        }
        
        .table-sm-compact th,
        .table-sm-compact td {
            padding: 0.375rem 0.5rem;
            font-size: 0.8125rem;
        }
        
        .tree-node {
            border-left: 2px solid #e9ecef;
            margin-left: 1rem;
            padding-left: 1rem;
            position: relative;
        }
        
        .tree-node::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 0;
            height: 1.5rem;
            width: 2px;
            background: #e9ecef;
        }
        
        .transaction-debit {
            color: var(--success-color);
            font-weight: 500;
        }
        
        .transaction-credit {
            color: var(--danger-color);
            font-weight: 500;
        }
        
        .badge-sm {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
        }
        
        .scrollable-table {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }
        
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.2s;
        }
        
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            .main-content {
                margin-left: 60px;
            }
            .sidebar-brand-text {
                display: none;
            }
        }
    </style>
</head>
<body class="h-100">
    <div id="app" x-data="app()" x-init="init()" class="d-flex h-100">
        <!-- Уведомления -->
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050; max-width: 350px;">
            <template x-for="notification in state.notifications" :key="notification.id">
                <div class="toast show mb-2" 
                     :class="{
                         'bg-success': notification.type === 'success',
                         'bg-danger': notification.type === 'error',
                         'bg-warning': notification.type === 'warning',
                         'bg-info': notification.type === 'info'
                     }"
                     role="alert">
                    <div class="toast-body text-white">
                        <div class="d-flex justify-content-between">
                            <span x-text="notification.message"></span>
                            <button type="button" class="btn-close btn-close-white" 
                                    @click="removeNotification(notification.id)"></button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Сайдбар -->
        <div class="sidebar d-flex flex-column" 
             :class="{ 'sidebar-collapsed': state.sidebarCollapsed }">
            
            <!-- Лого и заголовок -->
            <div class="p-3 border-bottom border-secondary">
                <div class="d-flex align-items-center">
                    <i class="fas fa-calculator fa-lg me-2"></i>
                    <span class="sidebar-brand-text" x-show="!state.sidebarCollapsed">
                        <strong>Pocket Accounting</strong>
                        <small class="d-block text-muted" x-text="'v' + state.version"></small>
                    </span>
                </div>
            </div>
            
            <!-- Навигация -->
            <nav class="flex-grow-1 p-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link-sidebar d-flex align-items-center" 
                           :class="{ 'active': state.currentView === 'dashboard' }"
                           @click.prevent="navigateTo('dashboard')">
                            <i class="fas fa-tachometer-alt me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Панель управления</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-sidebar d-flex align-items-center"
                           :class="{ 'active': state.currentView === 'transactions' }"
                           @click.prevent="navigateTo('transactions')">
                            <i class="fas fa-exchange-alt me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Операции</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-sidebar d-flex align-items-center"
                           :class="{ 'active': state.currentView === 'rules' }"
                           @click.prevent="navigateTo('rules')">
                            <i class="fas fa-sitemap me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Правила</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-sidebar d-flex align-items-center"
                           :class="{ 'active': state.currentView === 'journal' }"
                           @click.prevent="navigateTo('journal')">
                            <i class="fas fa-book me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Журнал</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-sidebar d-flex align-items-center"
                           :class="{ 'active': state.currentView === 'reports' }"
                           @click.prevent="navigateTo('reports')">
                            <i class="fas fa-chart-bar me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Отчеты</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-sidebar d-flex align-items-center"
                           :class="{ 'active': state.currentView === 'accounts' }"
                           @click.prevent="navigateTo('accounts')">
                            <i class="fas fa-list-alt me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Счета</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-sidebar d-flex align-items-center"
                           :class="{ 'active': state.currentView === 'contractors' }"
                           @click.prevent="navigateTo('contractors')">
                            <i class="fas fa-users me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Контрагенты</span>
                        </a>
                    </li>
                    <li class="nav-item mt-3">
                        <a class="nav-link-sidebar d-flex align-items-center"
                           :class="{ 'active': state.currentView === 'settings' }"
                           @click.prevent="navigateTo('settings')">
                            <i class="fas fa-cog me-2" style="width: 20px;"></i>
                            <span x-show="!state.sidebarCollapsed">Настройки</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- Свернуть/развернуть -->
            <div class="p-3 border-top border-secondary">
                <button class="btn btn-outline-light btn-sm w-100"
                        @click="toggleSidebar()">
                    <i class="fas" :class="state.sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                    <span x-show="!state.sidebarCollapsed">Свернуть</span>
                </button>
            </div>
        </div>
        
        <!-- Основной контент -->
        <div class="main-content flex-grow-1 d-flex flex-column" 
             :class="{ 'main-content-expanded': state.sidebarCollapsed }">
            
            <!-- Шапка -->
            <header class="bg-white shadow-sm border-bottom py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2"
                                @click="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="h5 mb-0 d-inline" x-text="getCurrentViewTitle()"></h1>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="text-muted me-3" x-text="getCurrentDate()"></span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle"
                                    type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user me-1"></i>
                                <span>Пользователь</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" @click.prevent="navigateTo('settings')"><i class="fas fa-cog me-2"></i>Настройки</a></li>
                                <li><a class="dropdown-item" href="#" @click.prevent="showHelp()"><i class="fas fa-question-circle me-2"></i>Справка</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" @click.prevent="exportAllData()"><i class="fas fa-download me-2"></i>Экспорт данных</a></li>
                                <li><a class="dropdown-item" href="#" @click.prevent="importData()"><i class="fas fa-upload me-2"></i>Импорт данных</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" @click.prevent="clearAllData()"><i class="fas fa-trash me-2 text-danger"></i>Очистить все данные</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Контент страницы -->
            <main class="flex-grow-1 p-3" style="overflow-y: auto;">
                
                <!-- Dashboard -->
                <div x-show="state.currentView === 'dashboard'">
                    <div class="row mb-3">
                        <!-- Статистика -->
                        <div class="col-md-3 mb-3">
                            <div class="card card-sm bg-primary text-white">
                                <div class="card-body-sm">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">Операции</h6>
                                            <h3 class="mb-0" x-text="data.transactions.length"></h3>
                                        </div>
                                        <i class="fas fa-exchange-alt fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card card-sm bg-success text-white">
                                <div class="card-body-sm">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">Обработано</h6>
                                            <h3 class="mb-0" x-text="getProcessedTransactions().length"></h3>
                                        </div>
                                        <i class="fas fa-check-circle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card card-sm bg-warning text-white">
                                <div class="card-body-sm">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">Ожидает</h6>
                                            <h3 class="mb-0" x-text="getPendingTransactions().length"></h3>
                                        </div>
                                        <i class="fas fa-clock fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card card-sm bg-info text-white">
                                <div class="card-body-sm">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">Правила</h6>
                                            <h3 class="mb-0" x-text="getActiveRules().length"></h3>
                                        </div>
                                        <i class="fas fa-sitemap fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Последние операции -->
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <div class="card card-sm">
                                <div class="card-header-sm">
                                    <span>Последние операции</span>
                                </div>
                                <div class="card-body-sm p-0">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-hover table-sm-compact mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Дата</th>
                                                    <th>Тип</th>
                                                    <th>Сумма</th>
                                                    <th>Статус</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="tx in data.transactions.slice().reverse().slice(0, 10)" :key="tx.id">
                                                    <tr @click="navigateTo('transactions')" class="cursor-pointer">
                                                        <td class="mono-font" x-text="formatDate(tx.date)"></td>
                                                        <td>
                                                            <small x-text="getOperationTypeName(tx.operationType)"></small>
                                                        </td>
                                                        <td class="mono-font text-end">
                                                            <span x-text="formatCurrency(tx.amount)"></span> ₽
                                                        </td>
                                                        <td>
                                                            <span class="badge badge-sm" 
                                                                  :class="tx.status === 'processed' ? 'bg-success' : 'bg-warning'"
                                                                  x-text="tx.status === 'processed' ? 'Обработано' : 'Ожидает'">
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Активные правила -->
                        <div class="col-md-4 mb-3">
                            <div class="card card-sm">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span>Активные правила</span>
                                    <button class="btn btn-sm btn-outline-primary" @click="navigateTo('rules')">
                                        Все
                                    </button>
                                </div>
                                <div class="card-body-sm">
                                    <template x-for="rule in getActiveRules().slice(0, 5)" :key="rule.id">
                                        <div class="border rounded p-2 mb-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong x-text="rule.name"></strong>
                                                    <div class="text-muted small" x-text="rule.description || 'Нет описания'"></div>
                                                </div>
                                                <span class="badge bg-secondary" x-text="rule.priority"></span>
                                            </div>
                                            <div class="small text-muted mt-1">
                                                <i class="fas fa-filter me-1"></i>
                                                <span x-text="rule.conditions.length"></span> условий
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Module -->
                <div x-show="state.currentView === 'transactions'" x-data="transactionModule()" x-init="init()">
                    <div class="row">
                        <!-- Левая колонка: Форма добавления -->
                        <div class="col-md-4 mb-3">
                            <div class="card card-sm h-100">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span>Новая операция</span>
                                    <button class="btn btn-sm btn-outline-secondary" @click="showImportModal()">
                                        <i class="fas fa-file-import"></i>
                                    </button>
                                </div>
                                <div class="card-body-sm">
                                    <form @submit.prevent="addTransaction">
                                        <div class="mb-3">
                                            <label class="form-label">Дата операции *</label>
                                            <input type="date" class="form-control" 
                                                   x-model="newTransaction.date" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Тип операции *</label>
                                            <select class="form-select" x-model="newTransaction.operationType" required>
                                                <option value="">Выберите тип</option>
                                                <template x-for="type in operationTypes" :key="type.id">
                                                    <option :value="type.id" x-text="type.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Контрагент</label>
                                            <div class="input-group">
                                                <select class="form-select" x-model="newTransaction.contractorId">
                                                    <option value="">Выберите контрагента</option>
                                                    <template x-for="contractor in contractors" :key="contractor.id">
                                                        <option :value="contractor.id" x-text="contractor.name"></option>
                                                    </template>
                                                </select>
                                                <button class="btn btn-outline-secondary" type="button" @click="navigateTo('contractors')">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Сумма *</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" 
                                                       step="0.01" min="0"
                                                       x-model="newTransaction.amount" required>
                                                <span class="input-group-text">₽</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Описание</label>
                                            <textarea class="form-control" rows="2"
                                                      x-model="newTransaction.description" placeholder="Например: Оплата по счету №123"></textarea>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary" 
                                                    :disabled="isProcessing">
                                                <template x-if="!isProcessing">
                                                    <span><i class="fas fa-plus me-1"></i> Добавить операцию</span>
                                                </template>
                                                <template x-if="isProcessing">
                                                    <span><i class="fas fa-spinner fa-spin me-1"></i> Обработка...</span>
                                                </template>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary"
                                                    @click="applyRulesToPending()">
                                                <i class="fas fa-bolt me-1"></i> Применить правила ко всем ожидающим
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Правая колонка: Список операций -->
                        <div class="col-md-8">
                            <div class="card card-sm">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span>Операции</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" 
                                                :class="{ 'active': filterStatus === 'all' }"
                                                @click="setFilter('all')">
                                            Все
                                        </button>
                                        <button class="btn btn-outline-success" 
                                                :class="{ 'active': filterStatus === 'processed' }"
                                                @click="setFilter('processed')">
                                            Обработанные
                                        </button>
                                        <button class="btn btn-outline-warning" 
                                                :class="{ 'active': filterStatus === 'pending' }"
                                                @click="setFilter('pending')">
                                            Ожидающие
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body-sm p-0">
                                    <div class="table-responsive scrollable-table" style="max-height: 500px;">
                                        <table class="table table-sm table-hover table-sm-compact mb-0">
                                            <thead class="sticky-top bg-white" style="top: 0;">
                                                <tr>
                                                    <th>Дата</th>
                                                    <th>Тип</th>
                                                    <th>Контрагент</th>
                                                    <th>Сумма</th>
                                                    <th>Статус</th>
                                                    <th>Правило</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="transaction in filteredTransactions" :key="transaction.id">
                                                    <tr :class="{
                                                        'table-success': transaction.status === 'processed',
                                                        'table-warning': transaction.status === 'pending'
                                                    }">
                                                        <td class="mono-font" x-text="formatDate(transaction.date)"></td>
                                                        <td>
                                                            <span x-text="getOperationTypeName(transaction.operationType)"></span>
                                                        </td>
                                                        <td>
                                                            <span x-text="getContractorName(transaction.contractorId) || '-'"></span>
                                                        </td>
                                                        <td class="mono-font text-end">
                                                            <span x-text="formatCurrency(transaction.amount)"></span> ₽
                                                        </td>
                                                        <td>
                                                            <span class="badge" 
                                                                  :class="{
                                                                      'bg-success': transaction.status === 'processed',
                                                                      'bg-warning': transaction.status === 'pending'
                                                                  }"
                                                                  x-text="transaction.status === 'processed' ? 'Обработано' : 'Ожидает'">
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <small x-text="transaction.ruleApplied ? 'Применено' : 'Не найдено'"></small>
                                                        </td>
                                                        <td>
                                                            <div class="btn-group btn-group-sm">
                                                                <button class="btn btn-outline-primary" 
                                                                        @click="applyRuleToTransaction(transaction.id)"
                                                                        title="Применить правило"
                                                                        :disabled="transaction.status === 'processed'">
                                                                    <i class="fas fa-bolt"></i>
                                                                </button>
                                                                <button class="btn btn-outline-info"
                                                                        @click="viewTransaction(transaction.id)"
                                                                        title="Просмотр">
                                                                    <i class="fas fa-eye"></i>
                                                                </button>
                                                                <button class="btn btn-outline-warning"
                                                                        @click="editTransaction(transaction.id)"
                                                                        title="Редактировать">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <button class="btn btn-outline-danger"
                                                                        @click="deleteTransaction(transaction.id)"
                                                                        title="Удалить">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Статистика -->
                                    <div class="p-3 border-top">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-success rounded-circle me-2" style="width: 10px; height: 10px;"></div>
                                                    <small>Обработано: <span x-text="processedCount"></span></small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-warning rounded-circle me-2" style="width: 10px; height: 10px;"></div>
                                                    <small>Ожидает: <span x-text="pendingCount"></span></small>
                                                </div>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <small class="text-muted">
                                                    Всего: <span x-text="totalCount"></span> операций
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно деталей операции -->
                    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Детали операции</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" x-html="transactionDetails"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно редактирования операции -->
                    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Редактирование операции</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="updateTransaction()">
                                        <div class="mb-3">
                                            <label class="form-label">Дата операции *</label>
                                            <input type="date" class="form-control" 
                                                   x-model="editingTransaction.date" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Тип операции *</label>
                                            <select class="form-select" x-model="editingTransaction.operationType" required>
                                                <option value="">Выберите тип</option>
                                                <template x-for="type in operationTypes" :key="type.id">
                                                    <option :value="type.id" x-text="type.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Контрагент</label>
                                            <select class="form-select" x-model="editingTransaction.contractorId">
                                                <option value="">Выберите контрагента</option>
                                                <template x-for="contractor in contractors" :key="contractor.id">
                                                    <option :value="contractor.id" x-text="contractor.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Сумма *</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" 
                                                       step="0.01" min="0"
                                                       x-model="editingTransaction.amount" required>
                                                <span class="input-group-text">₽</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Описание</label>
                                            <textarea class="form-control" rows="2"
                                                      x-model="editingTransaction.description"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Статус</label>
                                            <select class="form-select" x-model="editingTransaction.status">
                                                <option value="pending">Ожидает</option>
                                                <option value="processed">Обработано</option>
                                            </select>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно импорта -->
                    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Импорт операций</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Формат файла</label>
                                        <select class="form-select" x-model="importFormat">
                                            <option value="csv">CSV (через запятую)</option>
                                            <option value="json">JSON</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label" x-text="importFormat === 'csv' ? 'CSV данные:' : 'JSON данные:'"></label>
                                        <textarea class="form-control" rows="10" x-model="importData" 
                                                  placeholder="Вставьте данные для импорта"></textarea>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Для CSV формата ожидаются колонки: date,operationType,amount,description
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" @click="processImport()">Импортировать</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rules Module -->
                <div x-show="state.currentView === 'rules'" x-data="ruleModule()" x-init="init()">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-sm">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span>Управление правилами</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success me-2" @click="showRuleModal()">
                                            <i class="fas fa-plus me-1"></i> Новое правило
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" @click="showVersionsModal()">
                                            <i class="fas fa-history me-1"></i> Версии
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body-sm">
                                    <!-- Фильтры -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control form-control-sm" 
                                                   placeholder="Поиск по названию или описанию..."
                                                   x-model="searchTerm"
                                                   @input="filterRules">
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" x-model="filterStatus">
                                                <option value="all">Все статусы</option>
                                                <option value="active">Активные</option>
                                                <option value="inactive">Неактивные</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-sm btn-outline-secondary w-100" @click="resetFilters">
                                                <i class="fas fa-redo me-1"></i> Сбросить
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Список правил -->
                                    <div class="table-responsive scrollable-table">
                                        <table class="table table-sm table-hover table-sm-compact">
                                            <thead>
                                                <tr>
                                                    <th>Название</th>
                                                    <th>Описание</th>
                                                    <th>Условия</th>
                                                    <th>Проводки</th>
                                                    <th>Приоритет</th>
                                                    <th>Статус</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="rule in filteredRules" :key="rule.id">
                                                    <tr>
                                                        <td>
                                                            <strong x-text="rule.name"></strong>
                                                            <div class="text-muted small" x-text="'v' + rule.version"></div>
                                                        </td>
                                                        <td>
                                                            <span x-text="rule.description || 'Нет описания'"></span>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-info" x-text="rule.conditions.length"></span>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-success" x-text="rule.actions.length"></span>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-secondary" x-text="rule.priority"></span>
                                                        </td>
                                                        <td>
                                                            <span class="badge" 
                                                                  :class="rule.active ? 'bg-success' : 'bg-secondary'"
                                                                  x-text="rule.active ? 'Активно' : 'Неактивно'">
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="btn-group btn-group-sm">
                                                                <button class="btn btn-outline-primary" 
                                                                        @click="editRule(rule.id)"
                                                                        title="Редактировать">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <button class="btn btn-outline-info"
                                                                        @click="testRule(rule.id)"
                                                                        title="Протестировать">
                                                                    <i class="fas fa-vial"></i>
                                                                </button>
                                                                <button class="btn btn-outline-secondary"
                                                                        @click="cloneRule(rule.id)"
                                                                        title="Копировать">
                                                                    <i class="fas fa-copy"></i>
                                                                </button>
                                                                <button class="btn btn-outline-warning"
                                                                        @click="toggleRuleStatus(rule.id)"
                                                                        :title="rule.active ? 'Деактивировать' : 'Активировать'">
                                                                    <i class="fas" :class="rule.active ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
                                                                </button>
                                                                <button class="btn btn-outline-danger"
                                                                        @click="deleteRule(rule.id)"
                                                                        title="Удалить">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Статистика -->
                                    <div class="mt-3 text-muted small">
                                        Показано <span x-text="filteredRules.length"></span> из <span x-text="rules.length"></span> правил
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно редактирования правила -->
                    <div class="modal fade" id="ruleModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <span x-text="editingRule ? 'Редактирование правила' : 'Создание правила'"></span>
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div x-show="editingRule">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Изменения будут сохранены как новая версия правила
                                        </div>
                                    </div>
                                    
                                    <!-- Форма правила -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Название правила *</label>
                                            <input type="text" class="form-control" 
                                                   x-model="currentRule.name" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Приоритет (чем меньше, тем выше)</label>
                                            <input type="number" class="form-control" 
                                                   x-model="currentRule.priority" min="1" max="100">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Описание</label>
                                        <textarea class="form-control" rows="2"
                                                  x-model="currentRule.description" placeholder="Описание назначения правила"></textarea>
                                    </div>
                                    
                                    <!-- Условия -->
                                    <div class="card card-sm mb-3">
                                        <div class="card-header-sm d-flex justify-content-between align-items-center">
                                            <span>Условия (ЕСЛИ)</span>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    @click="addCondition()">
                                                <i class="fas fa-plus me-1"></i> Добавить условие
                                            </button>
                                        </div>
                                        <div class="card-body-sm">
                                            <template x-for="(condition, index) in currentRule.conditions" :key="index">
                                                <div class="border rounded p-3 mb-2">
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span class="text-muted">Условие #<span x-text="index + 1"></span></span>
                                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                                @click="removeCondition(index)">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <div class="row g-2 compact-form">
                                                        <div class="col-md-4">
                                                            <select class="form-select form-select-sm"
                                                                    x-model="condition.field">
                                                                <option value="">Выберите поле</option>
                                                                <option value="operationType">Тип операции</option>
                                                                <option value="contractorId">Контрагент</option>
                                                                <option value="amount">Сумма</option>
                                                                <option value="description">Описание</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <select class="form-select form-select-sm"
                                                                    x-model="condition.operator">
                                                                <option value="==">равно</option>
                                                                <option value="!=">не равно</option>
                                                                <option value=">">больше</option>
                                                                <option value="<">меньше</option>
                                                                <option value=">=">больше или равно</option>
                                                                <option value="<=">меньше или равно</option>
                                                                <option value="contains">содержит</option>
                                                                <option value="startsWith">начинается с</option>
                                                                <option value="endsWith">заканчивается на</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-5">
                                                            <input type="text" class="form-control form-control-sm"
                                                                   x-model="condition.value"
                                                                   placeholder="Значение">
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <div x-show="currentRule.conditions.length === 0" class="text-center text-muted py-3">
                                                <i class="fas fa-filter fa-2x mb-2"></i>
                                                <p>Условия не добавлены. Добавьте хотя бы одно условие.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Действия -->
                                    <div class="card card-sm mb-3">
                                        <div class="card-header-sm d-flex justify-content-between align-items-center">
                                            <span>Действия (ТО)</span>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    @click="addAction()">
                                                <i class="fas fa-plus me-1"></i> Добавить действие
                                            </button>
                                        </div>
                                        <div class="card-body-sm">
                                            <template x-for="(action, index) in currentRule.actions" :key="index">
                                                <div class="border rounded p-3 mb-2">
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span class="text-muted">Проводка #<span x-text="index + 1"></span></span>
                                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                                @click="removeAction(index)">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <div class="row g-2 compact-form">
                                                        <div class="col-md-5">
                                                            <label class="form-label small">Счет Дебета</label>
                                                            <select class="form-select form-select-sm"
                                                                    x-model="action.debit">
                                                                <option value="">Выберите счет</option>
                                                                <template x-for="account in accounts" :key="account.code">
                                                                    <option :value="account.code" 
                                                                            x-text="account.code + ' - ' + account.name">
                                                                    </option>
                                                                </template>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-5">
                                                            <label class="form-label small">Счет Кредита</label>
                                                            <select class="form-select form-select-sm"
                                                                    x-model="action.credit">
                                                                <option value="">Выберите счет</option>
                                                                <template x-for="account in accounts" :key="account.code">
                                                                    <option :value="account.code" 
                                                                            x-text="account.code + ' - ' + account.name">
                                                                    </option>
                                                                </template>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label small">Сумма</label>
                                                            <select class="form-select form-select-sm"
                                                                    x-model="action.amount">
                                                                <option value="full">100%</option>
                                                                <option value="half">50%</option>
                                                                <option value="quarter">25%</option>
                                                                <option value="custom">Произв.</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <div x-show="currentRule.actions.length === 0" class="text-center text-muted py-3">
                                                <i class="fas fa-exchange-alt fa-2x mb-2"></i>
                                                <p>Действия не добавлены. Добавьте хотя бы одно действие.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                    <button type="button" class="btn btn-primary" @click="saveRule()">
                                        <i class="fas fa-save me-1"></i>
                                        <span x-text="editingRule ? 'Сохранить изменения' : 'Создать правило'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно версий -->
                    <div class="modal fade" id="versionsModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">История версий правил</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Правило</th>
                                                    <th>Версия</th>
                                                    <th>Дата изменения</th>
                                                    <th>Условий</th>
                                                    <th>Действий</th>
                                                    <th>Статус</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="rule in rules" :key="rule.id + '_' + rule.version">
                                                    <tr>
                                                        <td x-text="rule.name"></td>
                                                        <td><span class="badge bg-secondary" x-text="rule.version"></span></td>
                                                        <td x-text="formatDate(rule.updated || rule.created)"></td>
                                                        <td x-text="rule.conditions.length"></td>
                                                        <td x-text="rule.actions.length"></td>
                                                        <td>
                                                            <span class="badge" 
                                                                  :class="rule.active ? 'bg-success' : 'bg-secondary'"
                                                                  x-text="rule.active ? 'Активно' : 'Неактивно'">
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" @click="restoreVersion(rule.id, rule.version)">
                                                                <i class="fas fa-history"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Journal Module -->
                <div x-show="state.currentView === 'journal'" x-data="journalModule()" x-init="init()">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-sm">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span>Журнал проводок</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" @click="exportJournal()">
                                            <i class="fas fa-download me-1"></i> Экспорт
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" @click="clearJournal()">
                                            <i class="fas fa-trash me-1"></i> Очистить
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body-sm">
                                    <!-- Фильтры -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <input type="date" class="form-control form-control-sm" 
                                                   x-model="filterDateFrom" @change="filterJournal">
                                        </div>
                                        <div class="col-md-3">
                                            <input type="date" class="form-control form-control-sm" 
                                                   x-model="filterDateTo" @change="filterJournal">
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" x-model="filterAccount" @change="filterJournal">
                                                <option value="">Все счета</option>
                                                <template x-for="account in accounts" :key="account.code">
                                                    <option :value="account.code" x-text="account.code + ' - ' + account.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-sm btn-outline-secondary w-100" @click="resetJournalFilters">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Таблица проводок -->
                                    <div class="table-responsive scrollable-table">
                                        <table class="table table-sm table-hover table-sm-compact">
                                            <thead>
                                                <tr>
                                                    <th>Дата</th>
                                                    <th>Дебет</th>
                                                    <th>Кредит</th>
                                                    <th>Сумма</th>
                                                    <th>Описание</th>
                                                    <th>Правило</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="entry in filteredJournal" :key="entry.id">
                                                    <tr>
                                                        <td class="mono-font" x-text="formatDate(entry.date)"></td>
                                                        <td>
                                                            <span class="transaction-debit mono-font" x-text="entry.debit"></span><br>
                                                            <small class="text-muted" x-text="getAccountName(entry.debit)"></small>
                                                        </td>
                                                        <td>
                                                            <span class="transaction-credit mono-font" x-text="entry.credit"></span><br>
                                                            <small class="text-muted" x-text="getAccountName(entry.credit)"></small>
                                                        </td>
                                                        <td class="mono-font text-end">
                                                            <span x-text="formatCurrency(entry.amount)"></span> ₽
                                                        </td>
                                                        <td>
                                                            <small x-text="entry.description || 'Без описания'"></small>
                                                        </td>
                                                        <td>
                                                            <small x-text="entry.ruleName || 'Вручную'"></small>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-danger" @click="deleteJournalEntry(entry.id)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Сводка -->
                                    <div class="mt-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card card-sm">
                                                    <div class="card-body-sm">
                                                        <h6 class="mb-2">Сводка по дебету</h6>
                                                        <template x-for="summary in debitSummary" :key="summary.account">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span x-text="summary.account + ' ' + getAccountName(summary.account)"></span>
                                                                <span class="mono-font" x-text="formatCurrency(summary.total) + ' ₽'"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card card-sm">
                                                    <div class="card-body-sm">
                                                        <h6 class="mb-2">Сводка по кредиту</h6>
                                                        <template x-for="summary in creditSummary" :key="summary.account">
                                                            <div class="d-flex justify-content-between mb-1">
                                                                <span x-text="summary.account + ' ' + getAccountName(summary.account)"></span>
                                                                <span class="mono-font" x-text="formatCurrency(summary.total) + ' ₽'"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Module -->
                <div x-show="state.currentView === 'reports'" x-data="reportModule()" x-init="init()">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card card-sm">
                                <div class="card-header-sm">Отчеты</div>
                                <div class="card-body-sm">
                                    <div class="list-group list-group-flush">
                                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                                @click="generateReport('turnover')">
                                            <span>Оборотно-сальдовая ведомость</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                                @click="generateReport('account_analysis')">
                                            <span>Анализ счета</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                                @click="generateReport('general_ledger')">
                                            <span>Главная книга</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                                @click="generateReport('tax')">
                                            <span>Налоговые отчеты</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card card-sm mt-3">
                                <div class="card-header-sm">Параметры отчета</div>
                                <div class="card-body-sm">
                                    <div class="mb-3">
                                        <label class="form-label">Период с</label>
                                        <input type="date" class="form-control" x-model="reportParams.dateFrom">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Период по</label>
                                        <input type="date" class="form-control" x-model="reportParams.dateTo">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Счет</label>
                                        <select class="form-select" x-model="reportParams.account">
                                            <option value="">Все счета</option>
                                            <template x-for="account in accounts" :key="account.code">
                                                <option :value="account.code" x-text="account.code + ' - ' + account.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary w-100" @click="applyReportParams()">Применить</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card card-sm">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span x-text="currentReport.name || 'Выберите отчет'"></span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" @click="exportReport()" :disabled="!currentReport.data">
                                            <i class="fas fa-download me-1"></i> Экспорт
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" @click="printReport()" :disabled="!currentReport.data">
                                            <i class="fas fa-print me-1"></i> Печать
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body-sm">
                                    <div x-show="!currentReport.data" class="text-center text-muted py-5">
                                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                        <p>Выберите отчет для генерации</p>
                                    </div>
                                    
                                    <div x-show="currentReport.data">
                                        <!-- Оборотно-сальдовая ведомость -->
                                        <template x-if="currentReport.type === 'turnover'">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th rowspan="2">Счет</th>
                                                            <th colspan="2" class="text-center">Остаток на начало</th>
                                                            <th colspan="2" class="text-center">Обороты за период</th>
                                                            <th colspan="2" class="text-center">Остаток на конец</th>
                                                        </tr>
                                                        <tr>
                                                            <th>Дебет</th>
                                                            <th>Кредит</th>
                                                            <th>Дебет</th>
                                                            <th>Кредит</th>
                                                            <th>Дебет</th>
                                                            <th>Кредит</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <template x-for="row in currentReport.data.rows" :key="row.account">
                                                            <tr>
                                                                <td class="mono-font" x-text="row.account + ' ' + row.accountName"></td>
                                                                <td class="mono-font text-end" x-text="formatCurrency(row.startDebit)"></td>
                                                                <td class="mono-font text-end" x-text="formatCurrency(row.startCredit)"></td>
                                                                <td class="mono-font text-end" x-text="formatCurrency(row.turnoverDebit)"></td>
                                                                <td class="mono-font text-end" x-text="formatCurrency(row.turnoverCredit)"></td>
                                                                <td class="mono-font text-end" x-text="formatCurrency(row.endDebit)"></td>
                                                                <td class="mono-font text-end" x-text="formatCurrency(row.endCredit)"></td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                    <tfoot class="table-light">
                                                        <tr>
                                                            <th>Итого:</th>
                                                            <th class="mono-font text-end" x-text="formatCurrency(currentReport.data.totals.startDebit)"></th>
                                                            <th class="mono-font text-end" x-text="formatCurrency(currentReport.data.totals.startCredit)"></th>
                                                            <th class="mono-font text-end" x-text="formatCurrency(currentReport.data.totals.turnoverDebit)"></th>
                                                            <th class="mono-font text-end" x-text="formatCurrency(currentReport.data.totals.turnoverCredit)"></th>
                                                            <th class="mono-font text-end" x-text="formatCurrency(currentReport.data.totals.endDebit)"></th>
                                                            <th class="mono-font text-end" x-text="formatCurrency(currentReport.data.totals.endCredit)"></th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </template>
                                        
                                        <!-- Анализ счета -->
                                        <template x-if="currentReport.type === 'account_analysis'">
                                            <div>
                                                <h6 class="mb-3" x-text="'Анализ счета: ' + currentReport.data.account + ' - ' + currentReport.data.accountName"></h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr>
                                                                <th>Дата</th>
                                                                <th>Документ</th>
                                                                <th>Дебет</th>
                                                                <th>Кредит</th>
                                                                <th>Остаток</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <template x-for="entry in currentReport.data.entries" :key="entry.id">
                                                                <tr>
                                                                    <td class="mono-font" x-text="formatDate(entry.date)"></td>
                                                                    <td x-text="entry.description"></td>
                                                                    <td class="mono-font text-end" x-text="entry.debit ? formatCurrency(entry.debit) + ' ₽' : ''"></td>
                                                                    <td class="mono-font text-end" x-text="entry.credit ? formatCurrency(entry.credit) + ' ₽' : ''"></td>
                                                                    <td class="mono-font text-end" x-text="formatCurrency(entry.balance) + ' ₽'"></td>
                                                                </tr>
                                                            </template>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Accounts Module -->
                <div x-show="state.currentView === 'accounts'" x-data="accountModule()" x-init="init()">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-sm">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span>План счетов</span>
                                    <button class="btn btn-sm btn-outline-success" @click="showAccountModal()">
                                        <i class="fas fa-plus me-1"></i> Добавить счет
                                    </button>
                                </div>
                                <div class="card-body-sm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control form-control-sm" 
                                                   placeholder="Поиск по коду или названию..."
                                                   x-model="searchTerm"
                                                   @input="filterAccounts">
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" x-model="filterType" @change="filterAccounts">
                                                <option value="">Все типы</option>
                                                <option value="active">Активные</option>
                                                <option value="passive">Пассивные</option>
                                                <option value="active-passive">Активно-пассивные</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-sm btn-outline-secondary w-100" @click="resetAccountFilters">
                                                <i class="fas fa-redo me-1"></i> Сбросить
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive scrollable-table">
                                        <table class="table table-sm table-hover table-sm-compact">
                                            <thead>
                                                <tr>
                                                    <th>Код</th>
                                                    <th>Наименование</th>
                                                    <th>Тип</th>
                                                    <th>Описание</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="account in filteredAccounts" :key="account.code">
                                                    <tr>
                                                        <td x-text="account.code" class="mono-font fw-bold"></td>
                                                        <td x-text="account.name"></td>
                                                        <td>
                                                            <span class="badge" 
                                                                  :class="{
                                                                      'bg-success': account.type === 'active',
                                                                      'bg-danger': account.type === 'passive',
                                                                      'bg-primary': account.type === 'active-passive'
                                                                  }"
                                                                  x-text="account.type === 'active' ? 'Активный' : account.type === 'passive' ? 'Пассивный' : 'Активно-пассивный'">
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <small class="text-muted" x-text="account.description || 'Нет описания'"></small>
                                                        </td>
                                                        <td>
                                                            <div class="btn-group btn-group-sm">
                                                                <button class="btn btn-outline-primary me-1" @click="editAccount(account.code)">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <button class="btn btn-outline-danger" @click="deleteAccount(account.code)">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно счета -->
                    <div class="modal fade" id="accountModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" x-text="editingAccount ? 'Редактирование счета' : 'Создание счета'"></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="saveAccount()">
                                        <div class="mb-3">
                                            <label class="form-label">Код счета *</label>
                                            <input type="text" class="form-control" 
                                                   x-model="currentAccount.code" 
                                                   :disabled="editingAccount" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Наименование *</label>
                                            <input type="text" class="form-control" 
                                                   x-model="currentAccount.name" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Тип счета *</label>
                                            <select class="form-select" x-model="currentAccount.type" required>
                                                <option value="">Выберите тип</option>
                                                <option value="active">Активный</option>
                                                <option value="passive">Пассивный</option>
                                                <option value="active-passive">Активно-пассивный</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Описание</label>
                                            <textarea class="form-control" rows="3"
                                                      x-model="currentAccount.description"></textarea>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">Сохранить</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contractors Module -->
                <div x-show="state.currentView === 'contractors'" x-data="contractorModule()" x-init="init()">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-sm">
                                <div class="card-header-sm d-flex justify-content-between align-items-center">
                                    <span>Контрагенты</span>
                                    <button class="btn btn-sm btn-outline-success" @click="showContractorModal()">
                                        <i class="fas fa-plus me-1"></i> Добавить контрагента
                                    </button>
                                </div>
                                <div class="card-body-sm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control form-control-sm" 
                                                   placeholder="Поиск по названию или ИНН..."
                                                   x-model="searchTerm"
                                                   @input="filterContractors">
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" x-model="filterType" @change="filterContractors">
                                                <option value="">Все типы</option>
                                                <option value="buyer">Покупатель</option>
                                                <option value="supplier">Поставщик</option>
                                                <option value="bank">Банк</option>
                                                <option value="other">Другое</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-sm btn-outline-secondary w-100" @click="resetContractorFilters">
                                                <i class="fas fa-redo me-1"></i> Сбросить
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive scrollable-table">
                                        <table class="table table-sm table-hover table-sm-compact">
                                            <thead>
                                                <tr>
                                                    <th>Название</th>
                                                    <th>Тип</th>
                                                    <th>ИНН</th>
                                                    <th>Телефон</th>
                                                    <th>Email</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="contractor in filteredContractors" :key="contractor.id">
                                                    <tr>
                                                        <td>
                                                            <strong x-text="contractor.name"></strong><br>
                                                            <small class="text-muted" x-text="contractor.address || 'Адрес не указан'"></small>
                                                        </td>
                                                        <td>
                                                            <span class="badge" 
                                                                  :class="{
                                                                      'bg-primary': contractor.type === 'buyer',
                                                                      'bg-info': contractor.type === 'supplier',
                                                                      'bg-success': contractor.type === 'bank',
                                                                      'bg-secondary': contractor.type === 'other'
                                                                  }"
                                                                  x-text="contractor.type === 'buyer' ? 'Покупатель' : contractor.type === 'supplier' ? 'Поставщик' : contractor.type === 'bank' ? 'Банк' : 'Другое'">
                                                            </span>
                                                        </td>
                                                        <td class="mono-font" x-text="contractor.inn || '-'"></td>
                                                        <td x-text="contractor.phone || '-'"></td>
                                                        <td x-text="contractor.email || '-'"></td>
                                                        <td>
                                                            <div class="btn-group btn-group-sm">
                                                                <button class="btn btn-outline-primary me-1" @click="editContractor(contractor.id)">
                                                                    <i class="fas fa-edit"></i>
                                                                </button>
                                                                <button class="btn btn-outline-danger" @click="deleteContractor(contractor.id)">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно контрагента -->
                    <div class="modal fade" id="contractorModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" x-text="editingContractor ? 'Редактирование контрагента' : 'Создание контрагента'"></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="saveContractor()">
                                        <div class="mb-3">
                                            <label class="form-label">Название *</label>
                                            <input type="text" class="form-control" 
                                                   x-model="currentContractor.name" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Тип *</label>
                                            <select class="form-select" x-model="currentContractor.type" required>
                                                <option value="">Выберите тип</option>
                                                <option value="buyer">Покупатель</option>
                                                <option value="supplier">Поставщик</option>
                                                <option value="bank">Банк</option>
                                                <option value="other">Другое</option>
                                            </select>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">ИНН</label>
                                                <input type="text" class="form-control" 
                                                       x-model="currentContractor.inn">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">КПП</label>
                                                <input type="text" class="form-control" 
                                                       x-model="currentContractor.kpp">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Адрес</label>
                                            <textarea class="form-control" rows="2"
                                                      x-model="currentContractor.address"></textarea>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Телефон</label>
                                                <input type="tel" class="form-control" 
                                                       x-model="currentContractor.phone">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" 
                                                       x-model="currentContractor.email">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Примечание</label>
                                            <textarea class="form-control" rows="3"
                                                      x-model="currentContractor.notes"></textarea>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">Сохранить</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Module -->
                <div x-show="state.currentView === 'settings'">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-sm mb-3">
                                <div class="card-header-sm">Настройки системы</div>
                                <div class="card-body-sm">
                                    <form @submit.prevent="saveSettings()">
                                        <div class="mb-3">
                                            <label class="form-label">Название организации *</label>
                                            <input type="text" class="form-control" 
                                                   x-model="data.settings.organizationName" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">ИНН организации</label>
                                            <input type="text" class="form-control" 
                                                   x-model="data.settings.organizationINN">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Система налогообложения *</label>
                                            <select class="form-select" x-model="data.settings.taxSystem" required>
                                                <option value="usn_income">УСН (Доходы)</option>
                                                <option value="usn_income_expense">УСН (Доходы-Расходы)</option>
                                                <option value="osno">ОСНО</option>
                                                <option value="patent">Патент</option>
                                                <option value="eshn">ЕСХН</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Валюта</label>
                                            <select class="form-select" x-model="data.settings.currency">
                                                <option value="RUB">Рубль (RUB)</option>
                                                <option value="USD">Доллар (USD)</option>
                                                <option value="EUR">Евро (EUR)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Автосохранение</label>
                                            <select class="form-select" x-model="data.settings.autoSave">
                                                <option value="true">Включено</option>
                                                <option value="false">Выключено</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" 
                                                   x-model="data.settings.showNotifications">
                                            <label class="form-check-label">Показывать уведомления</label>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">Сохранить настройки</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card card-sm mb-3">
                                <div class="card-header-sm">Управление данными</div>
                                <div class="card-body-sm">
                                    <div class="mb-3">
                                        <h6 class="mb-3">Резервное копирование</h6>
                                        <button class="btn btn-outline-primary w-100 mb-2" @click="exportAllData()">
                                            <i class="fas fa-download me-2"></i>Экспорт всех данных
                                        </button>
                                        <button class="btn btn-outline-secondary w-100 mb-2" @click="importData()">
                                            <i class="fas fa-upload me-2"></i>Импорт данных
                                        </button>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="mb-3">Очистка данных</h6>
                                        <button class="btn btn-outline-danger w-100 mb-2" @click="clearAllData()">
                                            <i class="fas fa-trash me-2"></i>Очистить все данные
                                        </button>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="mb-3">Статистика</h6>
                                        <div class="small">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Операции:</span>
                                                <span x-text="data.transactions.length"></span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Правила:</span>
                                                <span x-text="data.rules.length"></span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Контрагенты:</span>
                                                <span x-text="data.contractors.length"></span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Проводки:</span>
                                                <span x-text="data.journal.length"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="mb-3">О программе</h6>
                                        <div class="small text-muted">
                                            <p>Pocket Accounting v<span x-text="state.version"></span></p>
                                            <p>Бухгалтерия в браузере</p>
                                            <p>Все данные хранятся локально в вашем браузере</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Футер -->
            <footer class="bg-light border-top py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        &copy; 2023 Pocket Accounting. Все права защищены.
                    </small>
                    <small class="text-muted">
                        Данные хранятся локально в вашем браузере
                    </small>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Глобальные переменные для доступа к данным приложения
        let globalApp = null;
        
        // Утилитарные функции
        const Utils = {
            formatCurrency: (amount) => {
                if (!amount && amount !== 0) return '0.00';
                return new Intl.NumberFormat('ru-RU', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            },
            
            formatDate: (date) => {
                if (!date) return '';
                try {
                    return new Date(date).toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (e) {
                    return date;
                }
            },
            
            generateId: () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            cloneDeep: (obj) => {
                return JSON.parse(JSON.stringify(obj));
            },
            
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            downloadJSON: (data, filename) => {
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        };
        
        // Основное приложение
        function app() {
            return {
                // Состояние приложения
                state: {
                    currentView: 'dashboard',
                    sidebarCollapsed: false,
                    isLoading: false,
                    notifications: [],
                    version: '1.0.0'
                },
                
                // Данные приложения
                data: {
                    // Транзакции
                    transactions: [],
                    
                    // Правила
                    rules: [],
                    
                    // План счетов
                    accounts: [
                        { code: '50', name: 'Касса', type: 'active', description: 'Наличные денежные средства в кассе организации' },
                        { code: '51', name: 'Расчетные счета', type: 'active', description: 'Денежные средства на расчетных счетах в банках' },
                        { code: '52', name: 'Валютные счета', type: 'active', description: 'Денежные средства в иностранной валюте на счетах в банках' },
                        { code: '58', name: 'Финансовые вложения', type: 'active', description: 'Финансовые вложения организации' },
                        { code: '60', name: 'Расчеты с поставщиками и подрядчиками', type: 'passive', description: 'Расчеты с поставщиками и подрядчиками за полученные товары, работы, услуги' },
                        { code: '62', name: 'Расчеты с покупателями и заказчиками', type: 'active', description: 'Расчеты с покупателями и заказчиками за проданные товары, работы, услуги' },
                        { code: '62.01', name: 'Расчеты с покупателями по основной деятельности', type: 'active', description: 'Расчеты с покупателями по основной деятельности' },
                        { code: '62.02', name: 'Авансы полученные', type: 'passive', description: 'Полученные авансы от покупателей' },
                        { code: '68', name: 'Расчеты по налогам и сборам', type: 'passive', description: 'Расчеты по налогам и сборам' },
                        { code: '69', name: 'Расчеты по социальному страхованию и обеспечению', type: 'passive', description: 'Расчеты по социальному страхованию и обеспечению' },
                        { code: '70', name: 'Расчеты с персоналом по оплате труда', type: 'passive', description: 'Расчеты с персоналом по оплате труда' },
                        { code: '71', name: 'Расчеты с подотчетными лицами', type: 'active-passive', description: 'Расчеты с подотчетными лицами' },
                        { code: '75', name: 'Расчеты с учредителями', type: 'active-passive', description: 'Расчеты с учредителями' },
                        { code: '76', name: 'Расчеты с разными дебиторами и кредиторами', type: 'active-passive', description: 'Расчеты с разными дебиторами и кредиторами' },
                        { code: '80', name: 'Уставный капитал', type: 'passive', description: 'Уставный капитал организации' },
                        { code: '84', name: 'Нераспределенная прибыль (непокрытый убыток)', type: 'passive', description: 'Нераспределенная прибыль или непокрытый убыток' },
                        { code: '90', name: 'Продажи', type: 'active-passive', description: 'Доходы и расходы по обычным видам деятельности' },
                        { code: '90.01', name: 'Выручка', type: 'passive', description: 'Выручка от продажи товаров, работ, услуг' },
                        { code: '90.02', name: 'Себестоимость продаж', type: 'active', description: 'Себестоимость проданных товаров, работ, услуг' },
                        { code: '90.03', name: 'Налог на добавленную стоимость', type: 'active', description: 'НДС с продаж' },
                        { code: '91', name: 'Прочие доходы и расходы', type: 'active-passive', description: 'Прочие доходы и расходы' },
                        { code: '99', name: 'Прибыли и убытки', type: 'active-passive', description: 'Прибыли и убытки' }
                    ],
                    
                    // Контрагенты
                    contractors: [
                        { id: '1', name: 'ООО "Ромашка"', type: 'buyer', inn: '1234567890', address: 'г. Москва, ул. Ленина, д. 1', phone: '+7 (495) 123-45-67', email: 'info@romashka.ru', notes: 'Основной покупатель' },
                        { id: '2', name: 'ИП Иванов И.И.', type: 'supplier', inn: '0987654321', address: 'г. Санкт-Петербург, пр. Невский, д. 10', phone: '+7 (812) 987-65-43', email: 'ivanov@mail.ru', notes: 'Поставщик канцелярии' },
                        { id: '3', name: 'АО "Тюльпан"', type: 'buyer', inn: '1122334455', address: 'г. Екатеринбург, ул. Мира, д. 5', phone: '+7 (343) 222-33-44', email: 'sales@tulip.ru', notes: 'Регулярный заказчик' }
                    ],
                    
                    // Типы операций
                    operationTypes: [
                        { id: 'payment', name: 'Оплата от покупателя' },
                        { id: 'advance', name: 'Аванс полученный' },
                        { id: 'expense', name: 'Расход по счету' },
                        { id: 'refund', name: 'Возврат поставщику' },
                        { id: 'tax', name: 'Налоговый платеж' },
                        { id: 'salary', name: 'Выплата зарплаты' },
                        { id: 'advance_report', name: 'Подотчетные средства' },
                        { id: 'investment', name: 'Финансовые вложения' },
                        { id: 'dividends', name: 'Выплата дивидендов' }
                    ],
                    
                    // Журнал проводок
                    journal: [],
                    
                    // Настройки
                    settings: {
                        organizationName: 'Моя организация',
                        organizationINN: '',
                        taxSystem: 'usn_income',
                        currency: 'RUB',
                        autoSave: 'true',
                        showNotifications: true
                    }
                },
                
                // Инициализация
                init() {
                    globalApp = this;
                    this.loadData();
                    this.setupRouter();
                },
                
                // Загрузка данных из LocalStorage
                loadData() {
                    const keys = ['transactions', 'rules', 'contractors', 'journal', 'settings', 'accounts'];
                    keys.forEach(key => {
                        const saved = localStorage.getItem(`pocket_accounting_${key}`);
                        if (saved) {
                            try {
                                this.data[key] = JSON.parse(saved);
                            } catch (e) {
                                console.error(`Error parsing ${key}:`, e);
                            }
                        }
                    });
                    
                    // Инициализация демо-данных если пусто
                    if (this.data.transactions.length === 0) {
                        this.initializeDemoData();
                    }
                },
                
                // Сохранение данных в LocalStorage
                saveData(key) {
                    if (this.data[key] !== undefined) {
                        localStorage.setItem(`pocket_accounting_${key}`, JSON.stringify(this.data[key]));
                    }
                },
                
                // Автосохранение
                autoSave: Utils.debounce(function(key) {
                    this.saveData(key);
                    this.addNotification('success', 'Данные сохранены');
                }, 1000),
                
                // Инициализация демо-данных
                initializeDemoData() {
                    // Демо-правила
                    this.data.rules = [
                        {
                            id: 'rule_1',
                            name: 'Оплата от покупателя',
                            description: 'Обычная оплата за товары/услуги',
                            conditions: [
                                { field: 'operationType', operator: '==', value: 'payment' }
                            ],
                            actions: [
                                { debit: '51', credit: '62.01', amount: 'full' }
                            ],
                            priority: 1,
                            version: '1.0',
                            created: new Date().toISOString(),
                            updated: new Date().toISOString(),
                            active: true
                        },
                        {
                            id: 'rule_2',
                            name: 'Аванс от покупателя',
                            description: 'Получение аванса от покупателя',
                            conditions: [
                                { field: 'operationType', operator: '==', value: 'advance' }
                            ],
                            actions: [
                                { debit: '51', credit: '62.02', amount: 'full' }
                            ],
                            priority: 2,
                            version: '1.0',
                            created: new Date().toISOString(),
                            updated: new Date().toISOString(),
                            active: true
                        },
                        {
                            id: 'rule_3',
                            name: 'Налоговый платеж',
                            description: 'Уплата налогов',
                            conditions: [
                                { field: 'operationType', operator: '==', value: 'tax' },
                                { field: 'description', operator: 'contains', value: 'НДС' }
                            ],
                            actions: [
                                { debit: '68', credit: '51', amount: 'full' }
                            ],
                            priority: 3,
                            version: '1.0',
                            created: new Date().toISOString(),
                            updated: new Date().toISOString(),
                            active: true
                        }
                    ];
                    
                    // Демо-транзакции
                    this.data.transactions = [
                        {
                            id: 'tx_1',
                            date: new Date().toISOString(),
                            operationType: 'payment',
                            contractorId: '1',
                            amount: 15000.00,
                            description: 'Оплата по счету №123 от ООО "Ромашка"',
                            status: 'processed',
                            ruleApplied: 'rule_1',
                            journalEntryId: 'je_1',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'tx_2',
                            date: new Date(Date.now() - 86400000).toISOString(),
                            operationType: 'advance',
                            contractorId: '3',
                            amount: 5000.00,
                            description: 'Аванс 50% от АО "Тюльпан"',
                            status: 'pending',
                            ruleApplied: null,
                            journalEntryId: null,
                            createdAt: new Date(Date.now() - 86400000).toISOString()
                        },
                        {
                            id: 'tx_3',
                            date: new Date(Date.now() - 172800000).toISOString(),
                            operationType: 'tax',
                            contractorId: '',
                            amount: 3000.00,
                            description: 'Уплата НДС за квартал',
                            status: 'processed',
                            ruleApplied: 'rule_3',
                            journalEntryId: 'je_2',
                            createdAt: new Date(Date.now() - 172800000).toISOString()
                        }
                    ];
                    
                    // Демо-проводки
                    this.data.journal = [
                        {
                            id: 'je_1',
                            transactionId: 'tx_1',
                            ruleId: 'rule_1',
                            date: new Date().toISOString(),
                            debit: '51',
                            credit: '62.01',
                            amount: 15000.00,
                            description: 'Оплата по счету №123 от ООО "Ромашка"',
                            ruleName: 'Оплата от покупателя',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'je_2',
                            transactionId: 'tx_3',
                            ruleId: 'rule_3',
                            date: new Date(Date.now() - 172800000).toISOString(),
                            debit: '68',
                            credit: '51',
                            amount: 3000.00,
                            description: 'Уплата НДС за квартал',
                            ruleName: 'Налоговый платеж',
                            createdAt: new Date(Date.now() - 172800000).toISOString()
                        }
                    ];
                    
                    // Сохранение демо-данных
                    ['rules', 'transactions', 'journal'].forEach(key => this.saveData(key));
                },
                
                // Настройка роутера
                setupRouter() {
                    window.addEventListener('hashchange', () => {
                        const hash = window.location.hash.substring(1) || 'dashboard';
                        this.state.currentView = hash;
                    });
                    
                    const initialHash = window.location.hash.substring(1) || 'dashboard';
                    this.state.currentView = initialHash;
                },
                
                // Навигация
                navigateTo(view) {
                    this.state.currentView = view;
                    window.location.hash = view;
                },
                
                // Переключение сайдбара
                toggleSidebar() {
                    this.state.sidebarCollapsed = !this.state.sidebarCollapsed;
                },
                
                // Добавление уведомления
                addNotification(type, message, duration = 5000) {
                    const id = Utils.generateId();
                    this.state.notifications.push({
                        id,
                        type,
                        message,
                        timestamp: new Date()
                    });
                    
                    setTimeout(() => {
                        this.removeNotification(id);
                    }, duration);
                },
                
                // Удаление уведомления
                removeNotification(id) {
                    const index = this.state.notifications.findIndex(n => n.id === id);
                    if (index > -1) {
                        this.state.notifications.splice(index, 1);
                    }
                },
                
                // Геттеры
                getCurrentViewTitle() {
                    const titles = {
                        dashboard: 'Панель управления',
                        transactions: 'Операции',
                        rules: 'Правила учета',
                        journal: 'Журнал проводок',
                        reports: 'Отчеты',
                        accounts: 'План счетов',
                        contractors: 'Контрагенты',
                        settings: 'Настройки'
                    };
                    return titles[this.state.currentView] || 'Pocket Accounting';
                },
                
                getCurrentDate() {
                    return new Date().toLocaleDateString('ru-RU', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },
                
                getActiveRules() {
                    return this.data.rules.filter(rule => rule.active);
                },
                
                getProcessedTransactions() {
                    return this.data.transactions.filter(tx => tx.status === 'processed');
                },
                
                getPendingTransactions() {
                    return this.data.transactions.filter(tx => tx.status === 'pending');
                },
                
                getAccountByCode(code) {
                    return this.data.accounts.find(acc => acc.code === code);
                },
                
                getContractorById(id) {
                    return this.data.contractors.find(c => c.id === id);
                },
                
                getOperationTypeName(typeId) {
                    const type = this.data.operationTypes.find(t => t.id === typeId);
                    return type ? type.name : typeId;
                },
                
                // Вспомогательные методы
                formatDate(date) {
                    return Utils.formatDate(date);
                },
                
                formatCurrency(amount) {
                    return Utils.formatCurrency(amount);
                },
                
                // Экспорт всех данных
                exportAllData() {
                    const exportData = {
                        version: this.state.version,
                        exportedAt: new Date().toISOString(),
                        data: this.data
                    };
                    
                    Utils.downloadJSON(exportData, `pocket_accounting_backup_${new Date().toISOString().split('T')[0]}.json`);
                    this.addNotification('success', 'Все данные экспортированы');
                },
                
                // Импорт данных
                importData() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const importedData = JSON.parse(event.target.result);
                                
                                if (confirm('Импортировать данные? Текущие данные будут заменены.')) {
                                    if (importedData.data) {
                                        Object.keys(importedData.data).forEach(key => {
                                            if (this.data[key] !== undefined) {
                                                this.data[key] = importedData.data[key];
                                            }
                                        });
                                        
                                        ['transactions', 'rules', 'contractors', 'journal', 'settings', 'accounts'].forEach(key => {
                                            this.saveData(key);
                                        });
                                        
                                        this.addNotification('success', 'Данные успешно импортированы');
                                        setTimeout(() => location.reload(), 1000);
                                    }
                                }
                            } catch (error) {
                                this.addNotification('error', 'Ошибка при импорте данных: неверный формат файла');
                            }
                        };
                        reader.readAsText(file);
                    };
                    
                    input.click();
                },
                
                // Очистка всех данных
                clearAllData() {
                    if (confirm('Вы уверены, что хотите удалить все данные? Это действие нельзя отменить.')) {
                        const keys = ['transactions', 'rules', 'contractors', 'journal', 'settings', 'accounts'];
                        keys.forEach(key => {
                            localStorage.removeItem(`pocket_accounting_${key}`);
                            this.data[key] = key === 'settings' ? {
                                organizationName: 'Моя организация',
                                organizationINN: '',
                                taxSystem: 'usn_income',
                                currency: 'RUB',
                                autoSave: 'true',
                                showNotifications: true
                            } : key === 'accounts' ? this.data.accounts : [];
                        });
                        
                        this.initializeDemoData();
                        this.addNotification('warning', 'Все данные очищены, загружены демо-данные');
                        setTimeout(() => location.reload(), 1000);
                    }
                },
                
                // Сохранение настроек
                saveSettings() {
                    this.saveData('settings');
                    this.addNotification('success', 'Настройки сохранены');
                },
                
                // Показать справку
                showHelp() {
                    alert('Pocket Accounting - бухгалтерская программа в браузере.\n\nОсновные функции:\n1. Создание операций\n2. Настройка правил для автоматических проводок\n3. Просмотр журнала проводок\n4. Генерация отчетов\n5. Управление планом счетов и контрагентами\n\nВсе данные хранятся локально в вашем браузере.');
                }
            };
        }
        
        // Модуль транзакций
        function transactionModule() {
            return {
                // Состояние модуля
                transactions: [],
                filteredTransactions: [],
                filterStatus: 'all',
                newTransaction: {
                    date: new Date().toISOString().split('T')[0],
                    operationType: '',
                    contractorId: '',
                    amount: 0,
                    description: '',
                    status: 'pending'
                },
                editingTransaction: {
                    date: '',
                    operationType: '',
                    contractorId: '',
                    amount: 0,
                    description: '',
                    status: 'pending'
                },
                operationTypes: [],
                contractors: [],
                rules: [],
                isProcessing: false,
                transactionDetails: '',
                importFormat: 'csv',
                importData: '',
                
                // Статистика
                get processedCount() {
                    return this.transactions.filter(t => t.status === 'processed').length;
                },
                get pendingCount() {
                    return this.transactions.filter(t => t.status === 'pending').length;
                },
                get totalCount() {
                    return this.transactions.length;
                },
                
                // Инициализация
                init() {
                    this.loadData();
                    this.filterTransactions();
                },
                
                // Загрузка данных
                loadData() {
                    if (globalApp) {
                        this.transactions = globalApp.data.transactions || [];
                        this.operationTypes = globalApp.data.operationTypes || [];
                        this.contractors = globalApp.data.contractors || [];
                        this.rules = globalApp.getActiveRules() || [];
                    }
                },
                
                // Фильтрация транзакций
                filterTransactions() {
                    if (this.filterStatus === 'all') {
                        this.filteredTransactions = [...this.transactions];
                    } else {
                        this.filteredTransactions = this.transactions.filter(
                            t => t.status === this.filterStatus
                        );
                    }
                    
                    this.filteredTransactions.sort((a, b) => 
                        new Date(b.date || 0) - new Date(a.date || 0)
                    );
                },
                
                // Установка фильтра
                setFilter(status) {
                    this.filterStatus = status;
                    this.filterTransactions();
                },
                
                // Форматирование даты
                formatDate(dateString) {
                    return Utils.formatDate(dateString);
                },
                
                // Форматирование валюты
                formatCurrency(amount) {
                    return Utils.formatCurrency(amount);
                },
                
                // Получение названия типа операции
                getOperationTypeName(typeId) {
                    if (globalApp) {
                        return globalApp.getOperationTypeName(typeId);
                    }
                    return typeId;
                },
                
                // Получение имени контрагента
                getContractorName(contractorId) {
                    if (!contractorId) return '';
                    if (globalApp) {
                        const contractor = globalApp.getContractorById(contractorId);
                        return contractor ? contractor.name : '';
                    }
                    return '';
                },
                
                // Добавление новой транзакции
                addTransaction() {
                    this.isProcessing = true;
                    
                    const transaction = {
                        ...this.newTransaction,
                        id: Utils.generateId(),
                        createdAt: new Date().toISOString()
                    };
                    
                    this.transactions.push(transaction);
                    
                    // Автоматически применяем правило если возможно
                    this.applyRuleToTransaction(transaction.id);
                    
                    this.saveTransactions();
                    this.resetForm();
                    this.filterTransactions();
                    
                    this.isProcessing = false;
                    
                    if (globalApp) {
                        globalApp.addNotification('success', 'Операция добавлена');
                    }
                },
                
                // Сброс формы
                resetForm() {
                    this.newTransaction = {
                        date: new Date().toISOString().split('T')[0],
                        operationType: '',
                        contractorId: '',
                        amount: 0,
                        description: '',
                        status: 'pending'
                    };
                },
                
                // Применение правила к транзакции
                applyRuleToTransaction(transactionId) {
                    if (!globalApp) return;
                    
                    const transactionIndex = this.transactions.findIndex(t => t.id === transactionId);
                    if (transactionIndex === -1) return;
                    
                    const transaction = this.transactions[transactionIndex];
                    if (transaction.status === 'processed') return;
                    
                    // Поиск подходящего правила
                    const matchingRule = this.findMatchingRule(transaction);
                    
                    if (matchingRule) {
                        // Создаем проводки для каждого действия
                        matchingRule.actions.forEach(action => {
                            const journalEntry = {
                                id: Utils.generateId(),
                                transactionId: transaction.id,
                                ruleId: matchingRule.id,
                                date: transaction.date,
                                debit: action.debit,
                                credit: action.credit,
                                amount: this.calculateAmount(transaction.amount, action.amount),
                                description: transaction.description,
                                ruleName: matchingRule.name,
                                createdAt: new Date().toISOString()
                            };
                            
                            globalApp.data.journal.push(journalEntry);
                        });
                        
                        // Обновляем транзакцию
                        transaction.status = 'processed';
                        transaction.ruleApplied = matchingRule.id;
                        
                        globalApp.saveData('journal');
                        globalApp.addNotification('success', 
                            `Правило "${matchingRule.name}" применено к операции`);
                    } else {
                        globalApp.addNotification('warning', 
                            'Не найдено подходящего правила для операции');
                    }
                    
                    this.saveTransactions();
                    this.filterTransactions();
                },
                
                // Поиск подходящего правила
                findMatchingRule(transaction) {
                    const sortedRules = [...this.rules].sort((a, b) => (a.priority || 10) - (b.priority || 10));
                    
                    for (const rule of sortedRules) {
                        if (this.checkConditions(rule.conditions || [], transaction)) {
                            return rule;
                        }
                    }
                    
                    return null;
                },
                
                // Проверка условий
                checkConditions(conditions, transaction) {
                    return conditions.every(condition => {
                        const value = transaction[condition.field];
                        if (value === undefined) return false;
                        
                        const conditionValue = String(condition.value).toLowerCase();
                        const transactionValue = String(value).toLowerCase();
                        
                        switch (condition.operator) {
                            case '==': return transactionValue == conditionValue;
                            case '!=': return transactionValue != conditionValue;
                            case '>': return parseFloat(value) > parseFloat(condition.value);
                            case '<': return parseFloat(value) < parseFloat(condition.value);
                            case '>=': return parseFloat(value) >= parseFloat(condition.value);
                            case '<=': return parseFloat(value) <= parseFloat(condition.value);
                            case 'contains': return transactionValue.includes(conditionValue);
                            case 'startsWith': return transactionValue.startsWith(conditionValue);
                            case 'endsWith': return transactionValue.endsWith(conditionValue);
                            default: return false;
                        }
                    });
                },
                
                // Расчет суммы
                calculateAmount(baseAmount, amountType) {
                    switch (amountType) {
                        case 'full': return baseAmount;
                        case 'half': return baseAmount / 2;
                        case 'quarter': return baseAmount / 4;
                        default: return baseAmount;
                    }
                },
                
                // Применение правил ко всем ожидающим
                applyRulesToPending() {
                    if (!globalApp) return;
                    
                    const pending = this.transactions.filter(t => t.status === 'pending');
                    
                    if (pending.length === 0) {
                        globalApp.addNotification('info', 'Нет ожидающих операций');
                        return;
                    }
                    
                    this.isProcessing = true;
                    let processed = 0;
                    
                    for (const transaction of pending) {
                        this.applyRuleToTransaction(transaction.id);
                        processed++;
                    }
                    
                    this.isProcessing = false;
                    globalApp.addNotification('success', 
                        `Обработано ${processed} из ${pending.length} операций`);
                },
                
                // Просмотр деталей транзакции
                viewTransaction(transactionId) {
                    const transaction = this.transactions.find(t => t.id === transactionId);
                    
                    if (!transaction || !globalApp) return;
                    
                    let html = `
                        <div class="mb-4">
                            <h6>Основная информация</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th width="40%">Дата:</th>
                                    <td>${this.formatDate(transaction.date)}</td>
                                </tr>
                                <tr>
                                    <th>Тип операции:</th>
                                    <td>${this.getOperationTypeName(transaction.operationType)}</td>
                                </tr>
                                <tr>
                                    <th>Контрагент:</th>
                                    <td>${this.getContractorName(transaction.contractorId) || 'Не указан'}</td>
                                </tr>
                                <tr>
                                    <th>Сумма:</th>
                                    <td><strong>${this.formatCurrency(transaction.amount)} ₽</strong></td>
                                </tr>
                                <tr>
                                    <th>Статус:</th>
                                    <td>
                                        <span class="badge ${transaction.status === 'processed' ? 'bg-success' : 'bg-warning'}">
                                            ${transaction.status === 'processed' ? 'Обработано' : 'Ожидает'}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Описание:</th>
                                    <td>${transaction.description || 'Нет описания'}</td>
                                </tr>
                                <tr>
                                    <th>Создано:</th>
                                    <td>${this.formatDate(transaction.createdAt)}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                    
                    // Если есть проводки
                    const journalEntries = globalApp.data.journal.filter(
                        je => je.transactionId === transaction.id
                    );
                    
                    if (journalEntries.length > 0) {
                        const rule = this.rules.find(r => r.id === journalEntries[0].ruleId);
                        
                        html += `
                            <div class="mb-4">
                                <h6>Бухгалтерские проводки</h6>
                                <p><small>Правило: ${rule ? rule.name : 'Неизвестно'}</small></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Дебет</th>
                                                <th>Кредит</th>
                                                <th>Сумма</th>
                                                <th>Описание</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        journalEntries.forEach(entry => {
                            const debitAccount = globalApp.getAccountByCode(entry.debit);
                            const creditAccount = globalApp.getAccountByCode(entry.credit);
                            
                            html += `
                                <tr>
                                    <td>
                                        <span class="mono-font">${entry.debit}</span><br>
                                        <small>${debitAccount ? debitAccount.name : 'Неизвестный счет'}</small>
                                    </td>
                                    <td>
                                        <span class="mono-font">${entry.credit}</span><br>
                                        <small>${creditAccount ? creditAccount.name : 'Неизвестный счет'}</small>
                                    </td>
                                    <td class="text-end mono-font">
                                        ${this.formatCurrency(entry.amount)} ₽
                                    </td>
                                    <td>${entry.description || ''}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                    
                    this.transactionDetails = html;
                    
                    const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
                    modal.show();
                },
                
                // Редактирование транзакции
                editTransaction(transactionId) {
                    const transaction = this.transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        this.editingTransaction = Utils.cloneDeep(transaction);
                        const modal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
                        modal.show();
                    }
                },
                
                // Обновление транзакции
                updateTransaction() {
                    const index = this.transactions.findIndex(t => t.id === this.editingTransaction.id);
                    if (index > -1) {
                        this.transactions[index] = this.editingTransaction;
                        
                        // Если статус изменился на "ожидает", сбрасываем правило
                        if (this.editingTransaction.status === 'pending') {
                            this.transactions[index].ruleApplied = null;
                        }
                        
                        this.saveTransactions();
                        this.filterTransactions();
                        
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editTransactionModal'));
                        modal.hide();
                        
                        if (globalApp) {
                            globalApp.addNotification('success', 'Операция обновлена');
                        }
                    }
                },
                
                // Удаление транзакции
                deleteTransaction(transactionId) {
                    if (confirm('Вы уверены, что хотите удалить эту операцию?')) {
                        const index = this.transactions.findIndex(t => t.id === transactionId);
                        if (index > -1) {
                            this.transactions.splice(index, 1);
                            this.saveTransactions();
                            this.filterTransactions();
                            
                            if (globalApp) {
                                globalApp.addNotification('warning', 'Операция удалена');
                            }
                        }
                    }
                },
                
                // Сохранение транзакций
                saveTransactions() {
                    if (globalApp) {
                        globalApp.data.transactions = this.transactions;
                        globalApp.saveData('transactions');
                    }
                },
                
                // Показать модальное окно импорта
                showImportModal() {
                    this.importData = '';
                    const modal = new bootstrap.Modal(document.getElementById('importModal'));
                    modal.show();
                },
                
                // Обработка импорта
                processImport() {
                    if (!this.importData.trim()) {
                        alert('Введите данные для импорта');
                        return;
                    }
                    
                    try {
                        let importedTransactions = [];
                        
                        if (this.importFormat === 'csv') {
                            const lines = this.importData.trim().split('\n');
                            const headers = lines[0].split(',').map(h => h.trim());
                            
                            for (let i = 1; i < lines.length; i++) {
                                const values = lines[i].split(',').map(v => v.trim());
                                const transaction = {};
                                
                                headers.forEach((header, index) => {
                                    if (header === 'date' && values[index]) {
                                        transaction.date = values[index];
                                    } else if (header === 'operationType' && values[index]) {
                                        transaction.operationType = values[index];
                                    } else if (header === 'amount' && values[index]) {
                                        transaction.amount = parseFloat(values[index]);
                                    } else if (header === 'description' && values[index]) {
                                        transaction.description = values[index];
                                    }
                                });
                                
                                if (transaction.date && transaction.operationType && transaction.amount) {
                                    importedTransactions.push({
                                        ...transaction,
                                        id: Utils.generateId(),
                                        status: 'pending',
                                        createdAt: new Date().toISOString()
                                    });
                                }
                            }
                        } else if (this.importFormat === 'json') {
                            importedTransactions = JSON.parse(this.importData);
                        }
                        
                        if (importedTransactions.length > 0) {
                            this.transactions.push(...importedTransactions);
                            this.saveTransactions();
                            this.filterTransactions();
                            
                            const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                            modal.hide();
                            
                            if (globalApp) {
                                globalApp.addNotification('success', `Импортировано ${importedTransactions.length} операций`);
                            }
                        } else {
                            alert('Не удалось импортировать операции. Проверьте формат данных.');
                        }
                    } catch (error) {
                        alert('Ошибка при импорте: ' + error.message);
                    }
                }
            };
        }
        
        // Модуль правил
        function ruleModule() {
            return {
                // Состояние модуля
                rules: [],
                filteredRules: [],
                searchTerm: '',
                filterStatus: 'all',
                editingRule: null,
                currentRule: {
                    id: null,
                    name: '',
                    description: '',
                    conditions: [],
                    actions: [],
                    priority: 10,
                    version: '1.0',
                    active: true
                },
                accounts: [],
                
                // Инициализация
                init() {
                    this.resetCurrentRule();
                    this.loadRules();
                },
                
                // Загрузка правил
                loadRules() {
                    if (globalApp) {
                        this.rules = globalApp.data.rules || [];
                        this.filteredRules = [...this.rules];
                        this.accounts = globalApp.data.accounts || [];
                    }
                },
                
                // Фильтрация правил
                filterRules() {
                    this.filteredRules = this.rules.filter(rule => {
                        const matchesSearch = !this.searchTerm || 
                            rule.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            (rule.description && rule.description.toLowerCase().includes(this.searchTerm.toLowerCase()));
                        
                        const matchesStatus = this.filterStatus === 'all' || 
                            (this.filterStatus === 'active' && rule.active) ||
                            (this.filterStatus === 'inactive' && !rule.active);
                        
                        return matchesSearch && matchesStatus;
                    });
                    
                    this.filteredRules.sort((a, b) => (a.priority || 10) - (b.priority || 10));
                },
                
                // Сброс фильтров
                resetFilters() {
                    this.searchTerm = '';
                    this.filterStatus = 'all';
                    this.filterRules();
                },
                
                // Показать модальное окно
                showRuleModal(ruleId = null) {
                    if (ruleId) {
                        this.editRule(ruleId);
                    } else {
                        this.resetCurrentRule();
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('ruleModal'));
                    modal.show();
                },
                
                // Сброс формы
                resetCurrentRule() {
                    this.editingRule = null;
                    this.currentRule = {
                        id: Utils.generateId(),
                        name: '',
                        description: '',
                        conditions: [],
                        actions: [],
                        priority: 10,
                        version: '1.0',
                        active: true,
                        created: new Date().toISOString()
                    };
                },
                
                // Добавление условия
                addCondition() {
                    this.currentRule.conditions.push({
                        field: '',
                        operator: '==',
                        value: ''
                    });
                },
                
                // Удаление условия
                removeCondition(index) {
                    this.currentRule.conditions.splice(index, 1);
                },
                
                // Добавление действия
                addAction() {
                    this.currentRule.actions.push({
                        debit: '',
                        credit: '',
                        amount: 'full'
                    });
                },
                
                // Удаление действия
                removeAction(index) {
                    this.currentRule.actions.splice(index, 1);
                },
                
                // Редактирование правила
                editRule(ruleId) {
                    const rule = this.rules.find(r => r.id === ruleId);
                    if (rule) {
                        this.editingRule = ruleId;
                        this.currentRule = Utils.cloneDeep(rule);
                    }
                },
                
                // Сохранение правила
                saveRule() {
                    if (!this.currentRule.name.trim()) {
                        alert('Введите название правила');
                        return;
                    }
                    
                    if (this.currentRule.conditions.length === 0) {
                        alert('Добавьте хотя бы одно условие');
                        return;
                    }
                    
                    if (this.currentRule.actions.length === 0) {
                        alert('Добавьте хотя бы одно действие');
                        return;
                    }
                    
                    if (!globalApp) return;
                    
                    if (this.editingRule) {
                        const oldRule = this.rules.find(r => r.id === this.editingRule);
                        if (oldRule) {
                            this.currentRule.version = this.incrementVersion(oldRule.version);
                            this.currentRule.updated = new Date().toISOString();
                            
                            const index = this.rules.findIndex(r => r.id === this.editingRule);
                            this.rules[index] = this.currentRule;
                        }
                    } else {
                        this.currentRule.created = new Date().toISOString();
                        this.rules.push(this.currentRule);
                    }
                    
                    globalApp.data.rules = this.rules;
                    globalApp.saveData('rules');
                    
                    this.filterRules();
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('ruleModal'));
                    modal.hide();
                    
                    globalApp.addNotification('success', 
                        this.editingRule ? 'Правило обновлено' : 'Правило создано');
                },
                
                // Увеличение версии
                incrementVersion(version) {
                    const parts = version.split('.');
                    const minor = parseInt(parts[1]) + 1;
                    return `${parts[0]}.${minor}`;
                },
                
                // Клонирование правила
                cloneRule(ruleId) {
                    const rule = this.rules.find(r => r.id === ruleId);
                    if (rule) {
                        const clonedRule = Utils.cloneDeep(rule);
                        clonedRule.id = Utils.generateId();
                        clonedRule.name = `${rule.name} (копия)`;
                        clonedRule.version = '1.0';
                        clonedRule.created = new Date().toISOString();
                        
                        this.rules.push(clonedRule);
                        
                        if (globalApp) {
                            globalApp.data.rules = this.rules;
                            globalApp.saveData('rules');
                            
                            this.filterRules();
                            globalApp.addNotification('success', 'Правило скопировано');
                        }
                    }
                },
                
                // Переключение статуса правила
                toggleRuleStatus(ruleId) {
                    const rule = this.rules.find(r => r.id === ruleId);
                    if (rule) {
                        rule.active = !rule.active;
                        rule.updated = new Date().toISOString();
                        
                        if (globalApp) {
                            globalApp.data.rules = this.rules;
                            globalApp.saveData('rules');
                            
                            this.filterRules();
                            globalApp.addNotification('info', 
                                rule.active ? 'Правило активировано' : 'Правило деактивировано');
                        }
                    }
                },
                
                // Удаление правила
                deleteRule(ruleId) {
                    if (confirm('Вы уверены, что хотите удалить это правило?')) {
                        const index = this.rules.findIndex(r => r.id === ruleId);
                        if (index > -1) {
                            this.rules.splice(index, 1);
                            
                            if (globalApp) {
                                globalApp.data.rules = this.rules;
                                globalApp.saveData('rules');
                                
                                this.filterRules();
                                globalApp.addNotification('warning', 'Правило удалено');
                            }
                        }
                    }
                },
                
                // Тестирование правила
                testRule(ruleId) {
                    if (globalApp) {
                        globalApp.addNotification('info', 'Тестирование правила: функция в разработке');
                    }
                },
                
                // Показать модальное окно версий
                showVersionsModal() {
                    const modal = new bootstrap.Modal(document.getElementById('versionsModal'));
                    modal.show();
                },
                
                // Восстановление версии
                restoreVersion(ruleId, version) {
                    if (confirm('Восстановить эту версию правила?')) {
                        const rule = this.rules.find(r => r.id === ruleId && r.version === version);
                        if (rule) {
                            const restoredRule = Utils.cloneDeep(rule);
                            restoredRule.version = this.incrementVersion(version);
                            restoredRule.updated = new Date().toISOString();
                            
                            const index = this.rules.findIndex(r => r.id === ruleId);
                            if (index > -1) {
                                this.rules[index] = restoredRule;
                            }
                            
                            if (globalApp) {
                                globalApp.data.rules = this.rules;
                                globalApp.saveData('rules');
                                
                                this.filterRules();
                                globalApp.addNotification('success', 'Версия правила восстановлена');
                            }
                        }
                    }
                },
                
                // Форматирование даты
                formatDate(dateString) {
                    return Utils.formatDate(dateString);
                }
            };
        }
        
        // Модуль журнала
        function journalModule() {
            return {
                // Состояние модуля
                journal: [],
                filteredJournal: [],
                accounts: [],
                filterDateFrom: '',
                filterDateTo: '',
                filterAccount: '',
                
                // Инициализация
                init() {
                    this.loadData();
                    this.filterJournal();
                },
                
                // Загрузка данных
                loadData() {
                    if (globalApp) {
                        this.journal = globalApp.data.journal || [];
                        this.accounts = globalApp.data.accounts || [];
                        
                        // Устанавливаем даты по умолчанию (последние 30 дней)
                        const today = new Date();
                        const monthAgo = new Date(today);
                        monthAgo.setDate(today.getDate() - 30);
                        
                        this.filterDateFrom = monthAgo.toISOString().split('T')[0];
                        this.filterDateTo = today.toISOString().split('T')[0];
                    }
                },
                
                // Фильтрация журнала
                filterJournal() {
                    let filtered = [...this.journal];
                    
                    if (this.filterDateFrom) {
                        filtered = filtered.filter(entry => 
                            new Date(entry.date || 0) >= new Date(this.filterDateFrom)
                        );
                    }
                    
                    if (this.filterDateTo) {
                        filtered = filtered.filter(entry => 
                            new Date(entry.date || 0) <= new Date(this.filterDateTo + 'T23:59:59')
                        );
                    }
                    
                    if (this.filterAccount) {
                        filtered = filtered.filter(entry => 
                            entry.debit === this.filterAccount || entry.credit === this.filterAccount
                        );
                    }
                    
                    this.filteredJournal = filtered.sort((a, b) => 
                        new Date(b.date || 0) - new Date(a.date || 0)
                    );
                },
                
                // Сброс фильтров
                resetJournalFilters() {
                    this.filterDateFrom = '';
                    this.filterDateTo = '';
                    this.filterAccount = '';
                    this.filterJournal();
                },
                
                // Форматирование даты
                formatDate(dateString) {
                    return Utils.formatDate(dateString);
                },
                
                // Форматирование валюты
                formatCurrency(amount) {
                    return Utils.formatCurrency(amount);
                },
                
                // Получение имени счета
                getAccountName(code) {
                    const account = this.accounts.find(acc => acc.code === code);
                    return account ? account.name : '';
                },
                
                // Сводка по дебету
                get debitSummary() {
                    const summary = {};
                    
                    this.filteredJournal.forEach(entry => {
                        if (!summary[entry.debit]) {
                            summary[entry.debit] = 0;
                        }
                        summary[entry.debit] += entry.amount || 0;
                    });
                    
                    return Object.keys(summary).map(code => ({
                        account: code,
                        total: summary[code]
                    })).sort((a, b) => b.total - a.total);
                },
                
                // Сводка по кредиту
                get creditSummary() {
                    const summary = {};
                    
                    this.filteredJournal.forEach(entry => {
                        if (!summary[entry.credit]) {
                            summary[entry.credit] = 0;
                        }
                        summary[entry.credit] += entry.amount || 0;
                    });
                    
                    return Object.keys(summary).map(code => ({
                        account: code,
                        total: summary[code]
                    })).sort((a, b) => b.total - a.total);
                },
                
                // Экспорт журнала
                exportJournal() {
                    const exportData = this.filteredJournal.map(entry => ({
                        Дата: this.formatDate(entry.date),
                        Дебет: entry.debit,
                        'Счет дебета': this.getAccountName(entry.debit),
                        Кредит: entry.credit,
                        'Счет кредита': this.getAccountName(entry.credit),
                        Сумма: entry.amount,
                        Описание: entry.description,
                        Правило: entry.ruleName || ''
                    }));
                    
                    Utils.downloadJSON(exportData, `journal_${new Date().toISOString().split('T')[0]}.json`);
                    
                    if (globalApp) {
                        globalApp.addNotification('success', 'Журнал экспортирован');
                    }
                },
                
                // Удаление проводки
                deleteJournalEntry(entryId) {
                    if (confirm('Вы уверены, что хотите удалить эту проводку?')) {
                        if (!globalApp) return;
                        
                        const index = globalApp.data.journal.findIndex(je => je.id === entryId);
                        
                        if (index > -1) {
                            // Находим связанную транзакцию и сбрасываем ее статус
                            const entry = globalApp.data.journal[index];
                            const transactionIndex = globalApp.data.transactions.findIndex(t => t.id === entry.transactionId);
                            
                            if (transactionIndex > -1) {
                                globalApp.data.transactions[transactionIndex].status = 'pending';
                                globalApp.data.transactions[transactionIndex].ruleApplied = null;
                                globalApp.data.transactions[transactionIndex].journalEntryId = null;
                            }
                            
                            globalApp.data.journal.splice(index, 1);
                            globalApp.saveData('journal');
                            globalApp.saveData('transactions');
                            
                            this.journal = globalApp.data.journal;
                            this.filterJournal();
                            
                            globalApp.addNotification('warning', 'Проводка удалена');
                        }
                    }
                },
                
                // Очистка журнала
                clearJournal() {
                    if (confirm('Вы уверены, что хотите очистить весь журнал проводок?')) {
                        if (!globalApp) return;
                        
                        globalApp.data.journal = [];
                        globalApp.saveData('journal');
                        
                        // Сбрасываем статусы транзакций
                        globalApp.data.transactions.forEach(tx => {
                            tx.status = 'pending';
                            tx.ruleApplied = null;
                            tx.journalEntryId = null;
                        });
                        globalApp.saveData('transactions');
                        
                        this.journal = [];
                        this.filterJournal();
                        
                        globalApp.addNotification('warning', 'Журнал проводок очищен');
                    }
                }
            };
        }
        
        // Модуль отчетов
        function reportModule() {
            return {
                // Состояние модуля
                currentReport: {
                    type: '',
                    name: '',
                    data: null
                },
                reportParams: {
                    dateFrom: '',
                    dateTo: '',
                    account: ''
                },
                accounts: [],
                journal: [],
                
                // Инициализация
                init() {
                    if (globalApp) {
                        this.accounts = globalApp.data.accounts || [];
                        this.journal = globalApp.data.journal || [];
                        
                        // Устанавливаем даты по умолчанию (текущий месяц)
                        const today = new Date();
                        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                        
                        this.reportParams.dateFrom = firstDay.toISOString().split('T')[0];
                        this.reportParams.dateTo = today.toISOString().split('T')[0];
                    }
                },
                
                // Генерация отчета
                generateReport(type) {
                    this.currentReport.type = type;
                    
                    switch (type) {
                        case 'turnover':
                            this.generateTurnoverReport();
                            break;
                        case 'account_analysis':
                            this.generateAccountAnalysis();
                            break;
                        case 'general_ledger':
                            this.currentReport.name = 'Главная книга';
                            this.currentReport.data = null; // В разработке
                            break;
                        case 'tax':
                            this.currentReport.name = 'Налоговые отчеты';
                            this.currentReport.data = null; // В разработке
                            break;
                    }
                },
                
                // Генерация оборотно-сальдовой ведомости
                generateTurnoverReport() {
                    this.currentReport.name = 'Оборотно-сальдовая ведомость';
                    
                    const filteredJournal = this.journal.filter(entry => {
                        if (this.reportParams.dateFrom && new Date(entry.date || 0) < new Date(this.reportParams.dateFrom)) {
                            return false;
                        }
                        if (this.reportParams.dateTo && new Date(entry.date || 0) > new Date(this.reportParams.dateTo + 'T23:59:59')) {
                            return false;
                        }
                        return true;
                    });
                    
                    const reportData = {
                        rows: [],
                        totals: {
                            startDebit: 0,
                            startCredit: 0,
                            turnoverDebit: 0,
                            turnoverCredit: 0,
                            endDebit: 0,
                            endCredit: 0
                        }
                    };
                    
                    // Для каждого счета рассчитываем показатели
                    this.accounts.forEach(account => {
                        if (this.reportParams.account && account.code !== this.reportParams.account) {
                            return;
                        }
                        
                        const accountEntries = filteredJournal.filter(entry => 
                            entry.debit === account.code || entry.credit === account.code
                        );
                        
                        // Начальные остатки (в простой реализации считаем 0)
                        const startDebit = 0;
                        const startCredit = 0;
                        
                        // Обороты
                        let turnoverDebit = 0;
                        let turnoverCredit = 0;
                        
                        accountEntries.forEach(entry => {
                            if (entry.debit === account.code) {
                                turnoverDebit += entry.amount || 0;
                            }
                            if (entry.credit === account.code) {
                                turnoverCredit += entry.amount || 0;
                            }
                        });
                        
                        // Конечные остатки
                        let endDebit = startDebit + turnoverDebit - turnoverCredit;
                        let endCredit = startCredit + turnoverCredit - turnoverDebit;
                        
                        if (endDebit < 0) {
                            endCredit = Math.abs(endDebit);
                            endDebit = 0;
                        } else if (endCredit < 0) {
                            endDebit = Math.abs(endCredit);
                            endCredit = 0;
                        }
                        
                        reportData.rows.push({
                            account: account.code,
                            accountName: account.name,
                            startDebit,
                            startCredit,
                            turnoverDebit,
                            turnoverCredit,
                            endDebit,
                            endCredit
                        });
                        
                        // Суммируем итоги
                        reportData.totals.startDebit += startDebit;
                        reportData.totals.startCredit += startCredit;
                        reportData.totals.turnoverDebit += turnoverDebit;
                        reportData.totals.turnoverCredit += turnoverCredit;
                        reportData.totals.endDebit += endDebit;
                        reportData.totals.endCredit += endCredit;
                    });
                    
                    this.currentReport.data = reportData;
                },
                
                // Генерация анализа счета
                generateAccountAnalysis() {
                    if (!this.reportParams.account) {
                        alert('Выберите счет для анализа');
                        return;
                    }
                    
                    const account = this.accounts.find(acc => acc.code === this.reportParams.account);
                    if (!account) {
                        alert('Счет не найден');
                        return;
                    }
                    
                    this.currentReport.name = `Анализ счета: ${account.code} - ${account.name}`;
                    
                    const filteredJournal = this.journal.filter(entry => {
                        if (this.reportParams.dateFrom && new Date(entry.date || 0) < new Date(this.reportParams.dateFrom)) {
                            return false;
                        }
                        if (this.reportParams.dateTo && new Date(entry.date || 0) > new Date(this.reportParams.dateTo + 'T23:59:59')) {
                            return false;
                        }
                        if (entry.debit !== account.code && entry.credit !== account.code) {
                            return false;
                        }
                        return true;
                    }).sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));
                    
                    let balance = 0;
                    const entries = filteredJournal.map(entry => {
                        let debit = 0;
                        let credit = 0;
                        
                        if (entry.debit === account.code) {
                            debit = entry.amount || 0;
                            balance += entry.amount || 0;
                        } else if (entry.credit === account.code) {
                            credit = entry.amount || 0;
                            balance -= entry.amount || 0;
                        }
                        
                        return {
                            id: entry.id,
                            date: entry.date,
                            description: entry.description,
                            debit,
                            credit,
                            balance
                        };
                    });
                    
                    this.currentReport.data = {
                        account: account.code,
                        accountName: account.name,
                        entries
                    };
                },
                
                // Применение параметров отчета
                applyReportParams() {
                    if (this.currentReport.type) {
                        this.generateReport(this.currentReport.type);
                    }
                },
                
                // Экспорт отчета
                exportReport() {
                    if (!this.currentReport.data) {
                        alert('Нет данных для экспорта');
                        return;
                    }
                    
                    Utils.downloadJSON(this.currentReport.data, 
                        `report_${this.currentReport.type}_${new Date().toISOString().split('T')[0]}.json`);
                    
                    if (globalApp) {
                        globalApp.addNotification('success', 'Отчет экспортирован');
                    }
                },
                
                // Печать отчета
                printReport() {
                    window.print();
                },
                
                // Форматирование валюты
                formatCurrency(amount) {
                    return Utils.formatCurrency(amount);
                },
                
                // Форматирование даты
                formatDate(dateString) {
                    return Utils.formatDate(dateString);
                }
            };
        }
        
        // Модуль счетов
        function accountModule() {
            return {
                // Состояние модуля
                accounts: [],
                filteredAccounts: [],
                searchTerm: '',
                filterType: '',
                editingAccount: null,
                currentAccount: {
                    code: '',
                    name: '',
                    type: '',
                    description: ''
                },
                
                // Инициализация
                init() {
                    this.loadAccounts();
                },
                
                // Загрузка счетов
                loadAccounts() {
                    if (globalApp) {
                        this.accounts = globalApp.data.accounts || [];
                        this.filteredAccounts = [...this.accounts];
                    }
                },
                
                // Фильтрация счетов
                filterAccounts() {
                    this.filteredAccounts = this.accounts.filter(account => {
                        const matchesSearch = !this.searchTerm || 
                            account.code.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            account.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            (account.description && account.description.toLowerCase().includes(this.searchTerm.toLowerCase()));
                        
                        const matchesType = !this.filterType || account.type === this.filterType;
                        
                        return matchesSearch && matchesType;
                    });
                    
                    this.filteredAccounts.sort((a, b) => a.code.localeCompare(b.code));
                },
                
                // Сброс фильтров
                resetAccountFilters() {
                    this.searchTerm = '';
                    this.filterType = '';
                    this.filterAccounts();
                },
                
                // Показать модальное окно счета
                showAccountModal(accountCode = null) {
                    if (accountCode) {
                        this.editAccount(accountCode);
                    } else {
                        this.resetCurrentAccount();
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('accountModal'));
                    modal.show();
                },
                
                // Сброс формы
                resetCurrentAccount() {
                    this.editingAccount = null;
                    this.currentAccount = {
                        code: '',
                        name: '',
                        type: '',
                        description: ''
                    };
                },
                
                // Редактирование счета
                editAccount(accountCode) {
                    const account = this.accounts.find(acc => acc.code === accountCode);
                    if (account) {
                        this.editingAccount = accountCode;
                        this.currentAccount = Utils.cloneDeep(account);
                    }
                },
                
                // Сохранение счета
                saveAccount() {
                    if (!this.currentAccount.code.trim()) {
                        alert('Введите код счета');
                        return;
                    }
                    
                    if (!this.currentAccount.name.trim()) {
                        alert('Введите наименование счета');
                        return;
                    }
                    
                    if (!this.currentAccount.type) {
                        alert('Выберите тип счета');
                        return;
                    }
                    
                    if (!globalApp) return;
                    
                    if (this.editingAccount) {
                        const index = this.accounts.findIndex(acc => acc.code === this.editingAccount);
                        if (index > -1) {
                            this.accounts[index] = this.currentAccount;
                        }
                    } else {
                        // Проверяем, нет ли уже счета с таким кодом
                        if (this.accounts.find(acc => acc.code === this.currentAccount.code)) {
                            alert('Счет с таким кодом уже существует');
                            return;
                        }
                        this.accounts.push(this.currentAccount);
                    }
                    
                    globalApp.data.accounts = this.accounts;
                    globalApp.saveData('accounts');
                    
                    this.filterAccounts();
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('accountModal'));
                    modal.hide();
                    
                    globalApp.addNotification('success', 
                        this.editingAccount ? 'Счет обновлен' : 'Счет создан');
                },
                
                // Удаление счета
                deleteAccount(accountCode) {
                    if (confirm('Вы уверены, что хотите удалить этот счет?')) {
                        if (!globalApp) return;
                        
                        // Проверяем, используется ли счет в проводках
                        const usedInJournal = globalApp.data.journal.some(entry => 
                            entry.debit === accountCode || entry.credit === accountCode
                        );
                        
                        if (usedInJournal) {
                            alert('Невозможно удалить счет, так как он используется в проводках');
                            return;
                        }
                        
                        const index = this.accounts.findIndex(acc => acc.code === accountCode);
                        if (index > -1) {
                            this.accounts.splice(index, 1);
                            
                            globalApp.data.accounts = this.accounts;
                            globalApp.saveData('accounts');
                            
                            this.filterAccounts();
                            globalApp.addNotification('warning', 'Счет удален');
                        }
                    }
                }
            };
        }
        
        // Модуль контрагентов
        function contractorModule() {
            return {
                // Состояние модуля
                contractors: [],
                filteredContractors: [],
                searchTerm: '',
                filterType: '',
                editingContractor: null,
                currentContractor: {
                    id: '',
                    name: '',
                    type: '',
                    inn: '',
                    kpp: '',
                    address: '',
                    phone: '',
                    email: '',
                    notes: ''
                },
                
                // Инициализация
                init() {
                    this.loadContractors();
                },
                
                // Загрузка контрагентов
                loadContractors() {
                    if (globalApp) {
                        this.contractors = globalApp.data.contractors || [];
                        this.filteredContractors = [...this.contractors];
                    }
                },
                
                // Фильтрация контрагентов
                filterContractors() {
                    this.filteredContractors = this.contractors.filter(contractor => {
                        const matchesSearch = !this.searchTerm || 
                            contractor.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                            (contractor.inn && contractor.inn.includes(this.searchTerm)) ||
                            (contractor.address && contractor.address.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
                            (contractor.notes && contractor.notes.toLowerCase().includes(this.searchTerm.toLowerCase()));
                        
                        const matchesType = !this.filterType || contractor.type === this.filterType;
                        
                        return matchesSearch && matchesType;
                    });
                    
                    this.filteredContractors.sort((a, b) => a.name.localeCompare(b.name));
                },
                
                // Сброс фильтров
                resetContractorFilters() {
                    this.searchTerm = '';
                    this.filterType = '';
                    this.filterContractors();
                },
                
                // Показать модальное окно контрагента
                showContractorModal(contractorId = null) {
                    if (contractorId) {
                        this.editContractor(contractorId);
                    } else {
                        this.resetCurrentContractor();
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('contractorModal'));
                    modal.show();
                },
                
                // Сброс формы
                resetCurrentContractor() {
                    this.editingContractor = null;
                    this.currentContractor = {
                        id: Utils.generateId(),
                        name: '',
                        type: '',
                        inn: '',
                        kpp: '',
                        address: '',
                        phone: '',
                        email: '',
                        notes: ''
                    };
                },
                
                // Редактирование контрагента
                editContractor(contractorId) {
                    const contractor = this.contractors.find(c => c.id === contractorId);
                    if (contractor) {
                        this.editingContractor = contractorId;
                        this.currentContractor = Utils.cloneDeep(contractor);
                    }
                },
                
                // Сохранение контрагента
                saveContractor() {
                    if (!this.currentContractor.name.trim()) {
                        alert('Введите название контрагента');
                        return;
                    }
                    
                    if (!this.currentContractor.type) {
                        alert('Выберите тип контрагента');
                        return;
                    }
                    
                    if (!globalApp) return;
                    
                    if (this.editingContractor) {
                        const index = this.contractors.findIndex(c => c.id === this.editingContractor);
                        if (index > -1) {
                            this.contractors[index] = this.currentContractor;
                        }
                    } else {
                        this.contractors.push(this.currentContractor);
                    }
                    
                    globalApp.data.contractors = this.contractors;
                    globalApp.saveData('contractors');
                    
                    this.filterContractors();
                    
                    const modal = bootstrap.Modal.getInstance(document.getElementById('contractorModal'));
                    modal.hide();
                    
                    globalApp.addNotification('success', 
                        this.editingContractor ? 'Контрагент обновлен' : 'Контрагент создан');
                },
                
                // Удаление контрагента
                deleteContractor(contractorId) {
                    if (confirm('Вы уверены, что хотите удалить этого контрагента?')) {
                        const index = this.contractors.findIndex(c => c.id === contractorId);
                        if (index > -1) {
                            this.contractors.splice(index, 1);
                            
                            if (globalApp) {
                                globalApp.data.contractors = this.contractors;
                                globalApp.saveData('contractors');
                                
                                this.filterContractors();
                                globalApp.addNotification('warning', 'Контрагент удален');
                            }
                        }
                    }
                }
            };
        }
        
        // Инициализация Alpine.js
        document.addEventListener('alpine:init', () => {
            console.log('Pocket Accounting инициализирован!');
            
            // Инициализация Bootstrap тултипов
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
</body>
</html>